<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cib.cap4j.cfn.grant.dao.IIPArcGrantDao">
	<resultMap id="arcgrantVO_result" type="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
        <id column="SQBZJ" property="sqbzj" />
        <result column="SQDXBH" property="sqdxbh" />
        <result column="SQZYBM" property="sqzybm" />
        <result column="SQZYLX" property="sqzylx" />
        <result column="QXYXDTDBH" property="qxyxdtdbh" />
        <result column="QXSXSJ" property="qxsxsj" />
        <result column="QXGQSJ" property="qxgqsj" />
        <result column="CJR" property="cjr" />
        <result column="CJSJ" property="cjsj" />
        <result column="ZHXGR" property="zhxgr" />
        <result column="ZHXGSJ" property="zhxgsj" />
        <result column="JLZT" property="jlzt" />
    </resultMap>
    
    <select id="findAllUrlGrant" resultType="java.util.HashMap">
        select g.sqdxbh roleid, u.urllj url from IP_RESURL u, IP_ARCGRANT g 
    	where u.urlbh = g.sqzybm and g.sqzylx = 'LJ' and u.urllx='0'
    </select>
    
    <select id="findGrantBySqdxbh" resultType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		SELECT * FROM IP_ARCGRANT
		WHERE SQDXBH = #{sqdxbh}
		AND SQZYBM=#{sqzybm}
		AND SQZYLX = #{sqzylx}
		AND JLZT='0'
    </select>
    
    <select id="findGrantBySqdx" resultMap="arcgrantVO_result" parameterType="java.util.List">
        select * from  IP_ARCGRANT
			where JLZT = '1' and SQDXBH in
			<foreach collection="list" item="listSqdx"  open="(" separator="," close=")">  
        	#{listSqdx}  
     		</foreach>  
    </select>
    <!-- 获取某一模块的授权信息 
    <select id="findSSmkGrantInfo" resultMap="arcgrantVO_result" parameterType="java.util.HashMap">
		SELECT *
		  FROM IP_ARCGRANT
		 WHERE SQDXBH = #{sqdxbh}
		   AND JLZT='1'
		   <if test="gnssmk != null and gnssmk!='other'">
		   AND SQZYBM IN
		       (SELECT URLBH FROM IP_RESURL WHERE URLLJ LIKE #{gnssmk})
		   </if>
		   <if test="gnssmk != null and gnssmk=='other'">
			   AND SQZYBM IN
			       (SELECT URLBH
			          FROM (SELECT SUBSTR(URLLJ, 0, INSTR(URLLJ, '/', 2)) ALLMODELFROMURL,
			                       URLBH,
			                       URLBM,
			                       URLLJ
			                  FROM IP_RESURL)
			         WHERE ALLMODELFROMURL NOT IN
			               (SELECT ALLMODELFROMMENU
			                  FROM (SELECT DISTINCT SUBSTR(CDURL, 0, INSTR(CDURL, '/', 2)) ALLMODELFROMMENU
			                          FROM IP_RESMENU
			                         WHERE CDURL IS NOT NULL
			   AND CDURL <![CDATA[ <> ]]> 'other')))                       		  	
		   </if>    
    </select>-->
     <select id="findSSmkGrantInfo" resultMap="arcgrantVO_result" parameterType="java.util.HashMap">
		SELECT *
		  FROM IP_ARCGRANT
		 WHERE SQDXBH = #{sqdxbh}
		   AND JLZT='1'
		   <if test="gnssmk != null and gnssmk!='other'">
		   AND SQZYBM IN
		       (SELECT URLBH FROM IP_RESURL WHERE URLLJ LIKE ${gnssmk}
                    UNION
                    SELECT CDXBM as urlbh
                      FROM IP_RESRELATION
                     WHERE ZDXBM = (select cdbh from ip_resmenu where cdurl=#{cdurl})
                       AND ZDXLX = 'CD'
                       AND CDXLX = 'LJ'		       
		       )
		   </if>
		   <if test="gnssmk != null and gnssmk=='other'">
			   AND SQZYBM IN
				<foreach item="id" index="index" collection="sqzybms"
					open="(" separator="," close=")">
					#{id}
				</foreach>                           		  	
		   </if>    
    </select>
    
    <insert id="saveGrant" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
    	insert into ip_arcgrant(sqbzj,sqdxbh,sqzybm,sqzylx,qxyxdtdbh,qxsxsj,qxgqsj,cjr,cjsj,zhxgr,zhxgsj,jlzt)
	values (#{sqbzj,jdbcType=VARCHAR},#{sqdxbh,jdbcType=VARCHAR},#{sqzybm,jdbcType=VARCHAR},#{sqzylx},#{qxyxdtdbh,jdbcType=VARCHAR},
	#{qxsxsj,jdbcType=TIMESTAMP},#{qxgqsj,jdbcType=TIMESTAMP},#{cjr,jdbcType=VARCHAR},#{cjsj,jdbcType=TIMESTAMP},
	#{zhxgr,jdbcType=VARCHAR},#{zhxgsj,jdbcType=TIMESTAMP},#{jlzt,jdbcType=VARCHAR})
    </insert>
    <!--通过授权对象编号删除授权信息  -->
    <update id="updateGrantBySqdxbh" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		UPDATE IP_ARCGRANT SET JLZT='0' WHERE SQDXBH=#{sqdxbh}
		<if test="sqzylx != null"> and sqzylx = #{sqzylx}</if>
		and jlzt='1'
    </update>
    <!--通过授权资源类型删除授权信息  -->
    <update id="updateGrantBySqzylx" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		UPDATE IP_ARCGRANT SET JLZT='0' WHERE SQDXBH =#{sqdxbh} AND SQZYBM IN (
		SELECT URLBH FROM IP_RESURL WHERE URLLJ IN(
			SELECT CDURL FROM IP_RESMENU WHERE CDBH IN(
				select SQZYBM from  IP_ARCGRANT WHERE SQDXBH=#{sqdxbh}
					 and sqzylx = #{sqzylx} AND JLZT='1') AND CDURL IS NOT NULL)) AND SQZYLX='LJ'
    </update>
    <update id="updateGrant" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		UPDATE IP_ARCGRANT 
		<set>
		 JLZT='0'
		</set> 
		 WHERE SQDXBH = #{sqdxbh}
		   AND SQZYLX = #{sqzylx}
		   AND JLZT = #{jlzt}
		   <if test="sqzybm != null and sqbzj != ''"> and sqzybm = #{sqzybm}</if>
    </update>
    
    <update id="updateGrant2" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		UPDATE IP_ARCGRANT 
		<set>
		 JLZT='1'
		</set> 
		 WHERE SQDXBH = #{sqdxbh}
		   AND SQZYLX = #{sqzylx}
		   AND JLZT = '0'
		   <if test="sqzybm != null and sqbzj != ''"> and sqzybm = #{sqzybm}</if>
    </update>
    <!-- 根据所属模块更新功能授权信息，未选中功能时记录状态改为失效 -->
    <update id="updateFuncGrant" parameterType="java.util.HashMap">
		UPDATE IP_ARCGRANT SET JLZT='0' WHERE SQZYBM IN(
		SELECT GNXXZJ FROM IP_RESFUNCTION WHERE GNSSMK= #{gnssmk})AND JLZT='1'    
    </update>
    <!-- 根据所属模块更新URL授权信息，未选中功能时记录状态改为失效同时URL记录状态也为失效 -->
    <update id="updateUrlGrant" parameterType="java.util.HashMap">
		UPDATE IP_ARCGRANT
		   SET JLZT = '0'
		 WHERE SQZYBM IN
		       (SELECT URLBH
		          FROM IP_RESURL
		         WHERE URLLJ IN
		               (SELECT GNDYURL FROM IP_RESFUNCTION WHERE GNSSMK = #{gnssmk})
		           AND JLZT = '1')
    </update>
    <!-- 更新授权URL权限信息，为无效。即记录状态为0 -->
    <update id="updateUrlGrantBySqdxbh" parameterType="java.util.HashMap">
		UPDATE IP_ARCGRANT SET JLZT='0'  WHERE SQDXBH = #{sqdxbh}
		   AND SQZYBM IN
		       (SELECT URLBH
		          FROM IP_RESURL
		         WHERE URLLJ LIKE ${gnssmk}
                  UNION ALL
                  SELECT CDXBM AS URLBH
                    FROM IP_RESRELATION
                   WHERE ZDXBM = #{cdbh}
                     AND ZDXLX = 'CD'
                     AND CDXLX = 'LJ')
    </update>
    <!-- 更新角色拥有未归属模块的所有功能权限为无效 -->
    <update id="updateRoleAllOtherFunc" parameterType="java.util.HashMap">
		update ip_arcgrant
		   set jlzt = '0'
		 where sqdxbh = #{sqdxbh}
		   and sqzybm in
		       (select gnxxzj
		          from ip_resfunction
		         where gnssmk not in
		               (select allmodelfrommenu
		                  from (select distinct substr(cdurl, 0, INSTR(cdurl, '/', 2)) allmodelfrommenu
		                          from ip_resmenu
		                         where cdurl is not null
		                           and cdurl <![CDATA[ <> ]]> 'other')))
		   and jlzt = '1'    
    </update>
	<!-- 更新角色拥有未归属模块的所有URL权限为无效 
    <update id="updateRoleAllOtherUrl" parameterType="java.util.HashMap">
		update ip_arcgrant set jlzt='0'
		 where sqdxbh = #{sqdxbh}
		   and sqzybm in
		       (select urlbh
		          from (select substr(urllj, 0, INSTR(urllj, '/', 2)) allmodelfromurl,
		                       urlbh,
		                       urlbm,
		                       urllj
		                  from ip_resurl)
		         where allmodelfromurl not in
		               (select allmodelfrommenu
		                  from (select distinct substr(cdurl, 0, INSTR(cdurl, '/', 2)) allmodelfrommenu
		                          from ip_resmenu
		                         where cdurl is not null
		                           and cdurl <![CDATA[ <> ]]> 'other')))
		    and jlzt='1'
    </update>-->
    <update id="updateRoleAllOtherUrl" parameterType="java.util.HashMap">
		update ip_arcgrant set jlzt='0'
		 where sqdxbh = #{sqdxbh}
		   and sqzybm in
		    <foreach item="id" index="index" collection="zybmsList"
				open="(" separator="," close=")">
				#{id}
			</foreach>
		    and jlzt='1'
    </update>
    
	<!--权限添加角色 -->
	<!-- 逻辑删除菜单拥有的所有角色权限 -->
	<update id="updateMenuRolePer" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		UPDATE IP_ARCGRANT SET JLZT='0'
		                 WHERE SQZYBM = #{sqzybm}
		                   AND JLZT = '1'
	</update>
	<!-- 更新菜单或URL拥有角色权限的记录状态为有效   jlzt:1 -->
	<update id="updateMenuOrUrlRolePer" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		UPDATE IP_ARCGRANT
		   SET JLZT = '1'
		 WHERE SQDXBH = #{sqdxbh}
		   AND SQZYBM = #{sqzybm}
		   AND JLZT = '0'	
	</update>
    <delete id="deleteUrlGrant" parameterType="java.util.HashMap">
		delete from IP_ARCGRANT g where g.sqzylx = 'LJ' and g.sqzybm in (
			select u.urlbh from IP_RESURL u where u.urllj = #{urllj} and u.urllx = #{urllx}
		)
    </delete>
    <!-- 更新菜单权限 -->
	<update id="updateMenuPer" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		UPDATE IP_ARCGRANT
		   SET JLZT = '0'
		 WHERE SQDXBH = #{sqdxbh}
		   AND SQZYBM = #{sqzybm}
		   AND JLZT = '1'
	</update>
	<!-- 获取已授权的同级菜单节点 -->
	<select id="getSamelevelPer" resultMap="arcgrantVO_result" parameterType="java.util.HashMap">
		 SELECT *
		   FROM IP_ARCGRANT
		  WHERE SQDXBH = #{sqdxbh}
		    AND JLZT = '1'
		    AND SQZYBM IN
		        (SELECT MENU.CDBH
		           FROM IP_RESMENU MENU,
		                (SELECT * FROM IP_RESMENU WHERE CDBH = #{cdbh}) RESMENU
		          WHERE MENU.SJCDBH = RESMENU.SJCDBH
		            AND MENU.CDBH <![CDATA[ <> ]]> RESMENU.CDBH)
	</select>
	
	<!-- 批处理 -->
	<!-- 删除授权 -->
    <delete id="deleteGrant" parameterType="java.util.HashMap">
		delete from IP_ARCGRANT g where sqdxbh = #{sqdxbh} and g.sqzybm = #{sqzybm} and g.sqzylx = #{sqzylx}
    </delete>
    <!-- 获取用户拥有的角色信息 -->
    <select id="selectYHroleinfo" parameterType="java.util.HashMap" resultMap="arcgrantVO_result">
		SELECT *
		  FROM IP_ARCGRANT ARC
		 WHERE JLZT = #{jlzt}
		   AND SQZYLX = #{sqzylx}
		   AND SQDXBH in (select jsbh from ip_role_staff where yhbh = #{yhbh})
    </select>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cib.cap4j.cfn.dataManage.dao.IIpDataPermissionDao">
		<resultMap id="ipDataPermission_result" type="com.cib.cap4j.cfn.dataManage.vo.IpDataPermissionVO">
		     <id column="SJBSJQXZJ" property="sjbsjqxzj" />
		     <id column="SJBSJQXBM" property="sjbsjqxbm" />
		     <result column="LBMC" property="lbmc" />
		     <result column="SSYM" property="ssym" />
		     <result column="QXDX" property="qxdx" />
		     <result column="KZY" property="kzy" />
		     <result column="KZTJ" property="kztj" />
		     <result column="BZ" property="bz" />
		     <result column="SFKYXG" property="sfkyxg" />
		     <result column="SFXS" property="sfxs" />
		     <result column="QTSFXS" property="qtsfxs" />
		     <result column="QTSFKXG" property="qtsfkxg" />
		     <result column="JGY" property="jgy" />
		     <result column="SFXZMRJGKZ" property="sfxzmrjgkz" />
		</resultMap>
		<select id="queryDataPermission" resultMap="ipDataPermission_result" parameterType="java.util.HashMap">
		     SELECT * FROM IP_DATA_PERMISSION WHERE 1=1
		    <if test="sjbsjqxbm != null">  AND SJBSJQXBM  like ${sjbsjqxbm}</if>
		    <if test="lbmc != null">  AND LBMC  like ${lbmc}</if>
		    <if test="ssym != null">  AND SSYM  like ${ssym}</if>
		</select>
		<select id="queryDataPermissionCount" resultType="int" parameterType="java.util.HashMap">
		     SELECT Count(*) FROM IP_DATA_PERMISSION WHERE 1=1
		    <if test="sjbsjqxbm != null">  AND SJBSJQXBM  like ${sjbsjqxbm}</if>
		    <if test="lbmc != null">  AND LBMC  like ${lbmc}</if>
		    <if test="ssym != null">  AND SSYM  like ${ssym}</if>
		</select>
		<select id="getDataPermission" resultMap="ipDataPermission_result" parameterType="com.cib.cap4j.cfn.dataManage.vo.IpDataPermissionVO">
		     SELECT * FROM IP_DATA_PERMISSION WHERE SJBSJQXZJ = #{sjbsjqxzj}
		</select>
		<!-- 保存权限基本信息 -->
		<insert id="savaDataPer" parameterType="com.cib.cap4j.cfn.dataManage.vo.IpDataPermissionVO">
			INSERT INTO IP_DATA_PERMISSION (SJBSJQXZJ, SJBSJQXBM, LBMC, SSYM, QXDX, KZY, KZTJ, BZ, SFKYXG, SFXS, QTSFXS, QTSFKXG, JGY)
VALUES (#{sjbsjqxzj}, #{sjbsjqxbm}, #{lbmc}, #{ssym}, #{qxdx,jdbcType = VARCHAR}, #{kzy,jdbcType = VARCHAR}, #{kztj}, #{bz,jdbcType = VARCHAR}, #{sfkyxg,jdbcType = VARCHAR}, #{sfxs,jdbcType = VARCHAR}, #{qtsfxs,jdbcType = VARCHAR}, #{qtsfkxg,jdbcType = VARCHAR}, #{jgy,jdbcType = VARCHAR})
		</insert>
		<!-- 更新权限基本信息 -->
		<update id = "updateDataPer" parameterType="com.cib.cap4j.cfn.dataManage.vo.IpDataPermissionVO">
			UPDATE IP_DATA_PERMISSION 
			<set>
			SJBSJQXBM=#{sjbsjqxbm},LBMC=#{lbmc},SSYM=#{ssym},KZTJ=#{kztj},KZY=#{kzy},BZ=#{bz} where SJBSJQXZJ=#{sjbsjqxzj}
			</set>
		</update>
		<!-- 删除数据表权限信息 -->
		<delete id = "delDataPer" parameterType="com.cib.cap4j.cfn.dataManage.vo.IpDataPermissionVO">
			DELETE FROM IP_DATA_PERMISSION WHERE SJBSJQXZJ=#{sjbsjqxzj}
		</delete>
		
     <select id="findRoleDataPer" resultMap="ipDataPermission_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			  SELECT * FROM IP_DATA_PERMISSION WHERE SJBSJQXZJ IN (SELECT SQZYBM FROM  IP_ARCGRANT ARC
            WHERE JLZT = #{jlzt}  AND SQZYLX = #{sqzylx} AND SQDXBH = #{sqdxbh}) 
    </select>
     <select id="findRoleDataPerCount" resultType="int" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			  SELECT COUNT(*) FROM IP_DATA_PERMISSION WHERE SJBSJQXZJ IN (SELECT SQZYBM FROM  IP_ARCGRANT ARC
            WHERE JLZT = #{jlzt}  AND SQZYLX =#{sqzylx} AND SQDXBH =#{sqdxbh})    
    </select>
    <!-- 获取用户拥有的管理类角色的数据库字段的数据权限信息 -->
    <select id="findStaffRoleDataPer" resultMap="ipDataPermission_result" parameterType="java.util.HashMap">
		SELECT *
		  FROM IP_DATA_PERMISSION
		 WHERE SJBSJQXZJ IN
		       (SELECT SQZYBM
		          FROM IP_ARCGRANT ARC
		         WHERE JLZT = #{jlzt}
		           AND SQZYLX = #{sqzylx}
		           AND SQDXBH IN
		               (SELECT JSBH
		                  FROM IP_ROLE
		                 WHERE JLZT = '1'
		                   AND JSBH IN (SELECT JSBH
		                                   FROM IP_ROLE_STAFF
		                                  WHERE YHBH = #{yhbh}) AND (JSLX ='3' OR JSLX='9')))
    </select>
    <!-- 获取用户拥有的合法角色可分配的数据库字段的数据权限Count-->
    <select id="findStaffRoleDataPerCount" resultType="int" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		  FROM IP_DATA_PERMISSION
		 WHERE SJBSJQXZJ IN
		       (SELECT SQZYBM
		          FROM IP_ARCGRANT ARC
		         WHERE JLZT = #{jlzt}
		           AND SQZYLX = #{sqzylx}
		           AND SQDXBH IN
		               (
							SELECT JSBH
							  FROM IP_ROLE
							 WHERE JLZT = '1'
							   AND JSBH IN (SELECT JSBH FROM IP_ROLE_STAFF WHERE YHBH = #{yhbh})
							   AND (JSLX = '3' OR JSLX = '9')

		                ))

    </select>
    
	<select id="findAssignedDataByYhbh" resultMap="ipDataPermission_result" parameterType="java.util.HashMap">
			SELECT * FROM IP_DATA_PERMISSION WHERE SJBSJQXZJ IN 
			( SELECT SQZYBM FROM  IP_ARCGRANT ARC WHERE JLZT = #{jlzt} AND SQZYLX = #{sqzylx} AND SQDXBH IN
				(SELECT R.JSBH FROM IP_ROLE R, IP_ROLE_STAFF RS WHERE (R.JSBH = RS.JSBH AND RS.YHBH = #{yhbh} AND R.JSZT='1') OR R.JSBH='R99999998'))
			 
	</select>
			
</mapper>		
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cib.cap4j.cfn.function.dao.IMenuMainDao">
		<resultMap id="ipResMenuVO_result" type="com.cib.cap4j.cfn.function.vo.IPResMenuVO">
        <id column="CDBH" property="cdbh" />
        <result column="CDBM" property="cdbm" />
        <result column="CDMC" property="cdmc" />
        <result column="CDURL" property="cdurl" />
        <result column="SJCDBH" property="sjcdbh" />
        <result column="CDSXH" property="cdsxh" />
        <result column="CDTP" property="cdtp" />
        <result column="SFXDLJ" property="sfxdlj" />
        <result column="CDDKCKSZWZ" property="cddkckszwz" />
        <result column="CDZXKJBH" property="cdzxkjbh" />
        <result column="CDSFKY" property="cdsfky" />
        <result column="CDSFKJ" property="cdsfkj" />
    </resultMap>
    <select id="findMenu" resultMap="ipResMenuVO_result" parameterType="com.cib.cap4j.cfn.function.vo.IPResMenuVO">
		 SELECT IMENU.*, IURL.URLBH CDURLBH
		   FROM IP_RESMENU IMENU
		   LEFT JOIN IP_RESURL IURL
		     ON IMENU.CDURL = IURL.URLLJ
		  WHERE 1 = 1 
		  <if test = "cdbh != null" >  and CDBH = #{cdbh} </if >
        ORDER BY CDSXH,CDMC
    </select>
    <select id="findAllMenu" resultMap="ipResMenuVO_result"  parameterType="com.cib.cap4j.cfn.function.vo.IPResMenuVO">
        SELECT * FROM IP_RESMENU WHERE 1=1
        <if test = "cdmc != null and cdmc != ''" >  and CDMC = #{cdmc} </if >
        <if test = "cdbh != null and cdbh != ''" >  and CDBH <![CDATA[ <> ]]> #{cdbh} </if >
    </select>
    <!-- 获取菜单信息及上级菜单名称 -->
    <select id="findsjMenuByCdbh" resultMap="ipResMenuVO_result" parameterType="com.cib.cap4j.cfn.function.vo.IPResMenuVO">
        SELECT IPM.*, IPRM.CDMC AS SJMC FROM IP_RESMENU IPM
			LEFT JOIN (SELECT CDBH, CDMC FROM IP_RESMENU) IPRM ON TRIM(IPM.SJCDBH) = TRIM(IPRM.CDBH)
			WHERE TRIM(IPM.CDBH) = #{cdbh,jdbcType=VARCHAR} 
    </select>
    
    <!-- 获取菜单的url -->
    <select id="findMenuUrl" resultMap="ipResMenuVO_result">
		select cdurl
		  from ip_resmenu
		 where cdurl is not null
		   and cdurl <![CDATA[ <> ]]> 'other'
    </select>
    
    <!--保存菜单信息  --> 
    <insert id="insertMenu" parameterType="com.cib.cap4j.cfn.function.vo.IPResMenuVO">
    	INSERT INTO IP_RESMENU(CDBH,CDBM,CDMC,CDURL,SJCDBH,CDSXH,CDTP,SFXDLJ,CDDKCKSZWZ,CDZXKJBH,CDSFKY,CDSFKJ)
		VALUES(#{cdbh},#{cdbm,jdbcType=VARCHAR},#{cdmc},#{cdurl,jdbcType=VARCHAR},#{sjcdbh},#{cdsxh},#{cdtp,jdbcType=VARCHAR},#{sfxdlj},#{cddkckszwz},#{cdzxkjbh,jdbcType=VARCHAR},#{cdsfky},#{cdsfkj})
    </insert>
    <!--修改菜单信息  --> 
     <update id="updateMenu" parameterType="com.cib.cap4j.cfn.function.vo.IPResMenuVO">
     	UPDATE IP_RESMENU
     	<set>
     	CDBM = #{cdbm,jdbcType=VARCHAR}, CDMC = #{cdmc},CDURL = #{cdurl,jdbcType=VARCHAR},SJCDBH= #{sjcdbh} ,CDSXH = #{cdsxh},CDTP = #{cdtp,jdbcType=VARCHAR},
     	SFXDLJ = #{sfxdlj},CDDKCKSZWZ = #{cddkckszwz},CDZXKJBH = #{cdzxkjbh,jdbcType=VARCHAR},CDSFKY=#{cdsfky},CDSFKJ=#{cdsfkj}
     	</set>
     	WHERE CDBH = #{cdbh} 
     </update>  
     <!-- 根据菜单编号删除菜单信息 -->
     <delete id="delMenu" parameterType="com.cib.cap4j.cfn.function.vo.IPResMenuVO">
     	DELETE FROM IP_RESMENU WHERE CDBH = #{cdbh}
     </delete>
     <!-- 获取所有菜单的信息和菜单对应的URL信息 -->
     <select id="findMenuUrlinfo" resultMap="ipResMenuVO_result">
		SELECT MENU.*, RESURL.URLBH AS CDURLBH, RESURL.URLMS
		  FROM IP_RESMENU MENU
		  LEFT JOIN IP_RESURL RESURL
		    ON MENU.CDURL = RESURL.URLLJ
		    ORDER BY CDSXH,CDMC
    </select>
    <!-- 获取登录用户自己用的菜单权限 -->
     <select id="findStaffMenuUrlInfo" resultMap="ipResMenuVO_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		SELECT MENU.*, RESURL.URLBH CDURLBH
		  FROM (SELECT *
		          FROM IP_RESMENU
		         WHERE CDBH IN
		               (SELECT SQZYBM
		                  FROM IP_ARCGRANT ARC
		                 WHERE JLZT = #{jlzt}
		                   AND SQZYLX = #{sqzylx}
		                   AND SQDXBH IN
		                       (SELECT JSBH
		          					FROM IP_ROLE
		       					  WHERE JLZT = '1'
					           AND JSBH IN
					               (SELECT JSBH FROM IP_ROLE_STAFF WHERE YHBH = #{yhbh}) AND
					                 (JSLX ='3' OR JSLX='9')
					            ))) MENU
		  LEFT JOIN IP_RESURL RESURL
		    ON MENU.CDURL = RESURL.URLLJ
		   ORDER BY CDSXH,CDMC 
    </select> 
    
     <!--获取角色拥有的菜单权限  -->
     <select id="findRoleMenu" resultMap="ipResMenuVO_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			SELECT MENU.*, RESURL.URLBH CDURLBH
  FROM (SELECT * FROM IP_RESMENU WHERE CDBH IN (
			   SELECT SQZYBM FROM  IP_ARCGRANT ARC
						WHERE JLZT = #{jlzt}  AND SQZYLX =#{sqzylx} AND SQDXBH =#{sqdxbh})) MENU left join
       IP_RESURL RESURL on MENU.CDURL = RESURL.URLLJ 
       ORDER BY MENU.CDSXH,MENU.CDMC
    </select> 
    <!-- 获取角色拥有的子节点菜单权限 -->     
     <select id="findRoleLeafMenu" resultMap="ipResMenuVO_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			SELECT MENU.*, RESURL.URLBH CDURLBH
  FROM (SELECT * FROM IP_RESMENU WHERE CDBH IN (
			   SELECT SQZYBM FROM  IP_ARCGRANT ARC
						WHERE JLZT = #{jlzt}  AND SQZYLX =#{sqzylx} AND SQDXBH =#{sqdxbh})) MENU left join
       IP_RESURL RESURL on MENU.CDURL = RESURL.URLLJ WHERE CDBH NOT IN (SELECT SJCDBH  FROM IP_RESMENU)
    </select>  
    <!-- 获取角色拥有的父节点菜单权限 -->     
     <select id="findRoleParentMenu" resultMap="ipResMenuVO_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			SELECT MENU.*, RESURL.URLBH CDURLBH
  FROM (SELECT * FROM IP_RESMENU WHERE CDBH IN (
			   SELECT SQZYBM FROM  IP_ARCGRANT ARC
						WHERE JLZT = #{jlzt}  AND SQZYLX =#{sqzylx} AND SQDXBH =#{sqdxbh})) MENU left join
       IP_RESURL RESURL on MENU.CDURL = RESURL.URLLJ WHERE CDBH IN (SELECT SJCDBH  FROM IP_RESMENU)
    </select>  
     
     <select id="findNotCommonMenu" resultMap="ipResMenuVO_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			SELECT MENU.*, RESURL.URLBH CDURLBH
  FROM (SELECT * FROM IP_RESMENU WHERE CDBH NOT IN (
			   SELECT SQZYBM FROM  IP_ARCGRANT ARC
						WHERE JLZT = #{jlzt}  AND SQZYLX =#{sqzylx} AND SQDXBH =#{sqdxbh})) MENU left join
       IP_RESURL RESURL on MENU.CDURL = RESURL.URLLJ
    </select>
    
    <select id="findGrantedMenu" resultMap="ipResMenuVO_result" parameterType="java.util.HashMap">
		select distinct m.cdbh, m.cdmc, m.sjcdbh, m.cdurl, m.cdsxh, m.cdtp, m.cdsfky, m.cdsfkj
		from IP_RESMENU m, IP_ARCGRANT g
		where m.cdbh = g.sqzybm and g.sqzylx = 'CD' and g.jlzt = '1' and m.cdsfkj = '1'
		and g.sqdxbh in
		<foreach item="id" index="index" collection="list"
			open="(" separator="," close=")">
			#{id}
		</foreach>
		<if test="pid != null"> and pid = #{pid}</if>
		order by m.cdsxh, m.cdmc
    </select>
    
    <select id="findAssignedMenuByYhbh" resultMap="ipResMenuVO_result" parameterType="java.util.HashMap">
			SELECT * FROM IP_RESMENU WHERE CDBH IN 
			( SELECT SQZYBM FROM  IP_ARCGRANT ARC WHERE JLZT = #{jlzt} AND SQZYLX = #{sqzylx} AND SQDXBH IN
				(SELECT R.JSBH FROM IP_ROLE R, IP_ROLE_STAFF RS WHERE (R.JSBH = RS.JSBH AND RS.YHBH = #{yhbh} AND R.JSZT='1') OR R.JSBH='R99999998')) order by CDMC
    </select> 
    <select id="findMenuByCdurl" resultType="java.lang.String" parameterType="java.lang.String">
			SELECT CDBH FROM IP_RESMENU WHERE 
			 <if test = "_parameter != null" >  CDURL = #{_parameter} </if >			
    </select> 
</mapper>

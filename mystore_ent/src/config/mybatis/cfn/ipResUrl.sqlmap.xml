<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cib.cap4j.cfn.function.dao.IUrlInfoDao">
	<resultMap id="ipResUrl_result" type="com.cib.cap4j.cfn.function.vo.IPResUrlVO">
		<id column="URLBH" property="urlbh" />
		<result column="URLBM" property="urlbm" />
		<result column="URLLJ" property="urllj" />
		<result column="URLMS" property="urlms" />
		<result column="URLLX" property="urllx" />
	</resultMap>
	<!--获取扫描后的URL信息 -->
	<select id="findUrl" resultMap="ipResUrl_result" parameterType="java.util.HashMap">
		SELECT * FROM IP_RESURL WHERE URLLX ='0'
		<if test="key != null"> AND URLLJ like ${key}</if>
		<if test="mkurl != null"> AND URLLJ like ${mkurl}</if>
		order by urllj
	</select>
	<!--获取除菜单路径外和模块*的URL信息 -->
	<select id="findNotmenuUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL
		WHERE urllj not in (select cdurl
		from ip_resmenu
		where cdurl is not null)
		and urlbh not in(select urlbh from ip_resurl where urllj like'%/**/*.*')
		<if test="key != null"> AND URLLJ like ${key}</if>
		order by urllj
	</select>
	<!--获取模块的URL信息和模块关联的url -->
	<select id="findMkRelationUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL
		WHERE URLLJ like ${ssmkLj}
		OR URLBH IN
		(SELECT CDXBM
		FROM IP_RESRELATION
		WHERE ZDXBM =
		(SELECT CDBH FROM IP_RESMENU WHERE CDURL = #{cdurl})
		AND ZDXLX = #{zdxlx}
		AND CDXLX = 'LJ')
		order by urllj
	</select>
	<insert id="addUrl" parameterType="com.cib.cap4j.cfn.function.vo.IPResUrlVO">
		INSERT INTO IP_RESURL(URLBH,URLBM,URLLJ,URLMS,URLLX)
		VALUES
		(#{urlbh,jdbcType=VARCHAR}, #{urlbm,jdbcType=VARCHAR}, #{urllj,jdbcType=VARCHAR},
		#{urlms,jdbcType=VARCHAR},#{urllx,jdbcType=VARCHAR})
	</insert>

	<update id="updateUrl" parameterType="com.cib.cap4j.cfn.function.vo.IPResUrlVO">
		UPDATE IP_RESURL
		<set>
			URLBM=#{urlbm,jdbcType=VARCHAR}, URLLJ=#{urllj,jdbcType=VARCHAR}, URLMS=#{urlms,jdbcType=VARCHAR}
		</set>
		WHERE URLBH= #{urlbh}
	</update>

	<update id="updateUrlByLj" parameterType="com.cib.cap4j.cfn.function.vo.IPResUrlVO">
		UPDATE IP_RESURL
		<set>
			URLBM=#{urlbm,jdbcType=VARCHAR}, URLMS=#{urlms,jdbcType=VARCHAR}
		</set>
		WHERE URLLJ= #{urllj} and URLLX = #{urllx}
	</update>

	<delete id="delUrlByUrlbh" parameterType="com.cib.cap4j.cfn.function.vo.IPResUrlVO">
		DELETE FROM IP_RESURL WHERE TRIM(URLBH) = #{urlbh}
	</delete>

	<delete id="delUrl" parameterType="com.cib.cap4j.cfn.function.vo.IPResUrlVO">
		DELETE FROM IP_RESURL WHERE 1 = 1
		<if test="urlbh != null and urlbh != ''"> and URLBH = #{urlbh}</if>
		<if test="urlbm != null and urlbm != ''"> and URLBM = #{urlbm}</if>
		<if test="urllj != null and urllj != ''"> and URLLJ = #{urllj}</if>
		<if test="urllx != null and urllx != ''"> and URLLX = #{urllx}</if>
	</delete>

	<delete id="delUrlByUrlBmAndUrllj" parameterType="com.cib.cap4j.cfn.function.vo.IPResUrlVO">
		DELETE FROM IP_RESURL WHERE URLBM= #{urlbm} AND URLLJ = #{urllj}
	</delete>

	<select id="findRoleUrl" resultMap="ipResUrl_result"
		parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		SELECT * FROM IP_RESURL WHERE URLBH IN (SELECT SQZYBM FROM IP_ARCGRANT ARC
		WHERE JLZT = #{jlzt} AND SQZYLX = #{sqzylx} AND SQDXBH = #{sqdxbh})
	</select>

	<select id="findRoleUrlCount" resultType="int"
		parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		SELECT COUNT(*) FROM IP_RESURL WHERE URLBH IN (SELECT SQZYBM FROM
		IP_ARCGRANT ARC
		WHERE JLZT = #{jlzt} AND SQZYLX =#{sqzylx} AND SQDXBH =#{sqdxbh})
	</select>
	<select id="findChooseUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		select url.* from (SELECT IPR.*,'1' AS CU FROM IP_RESURL IPR WHERE
		URLBH IN (SELECT SQZYBM FROM IP_ARCGRANT ARC
		WHERE JLZT = #{jlzt} AND SQZYLX = #{sqzylx} AND SQDXBH = #{sqdxbh})
		union
		all
		SELECT IPR.*,'0' AS CU FROM IP_RESURL IPR WHERE URLBH not IN (SELECT SQZYBM
		FROM IP_ARCGRANT ARC
		WHERE JLZT = #{jlzt} AND SQZYLX =#{sqzylx} AND SQDXBH = #{sqdxbh})) url
		where 1=1
		<if test="urllj != null"> and urllj like ${urllj}</if>
	</select>

	<select id="findChooseUrls" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		select url.* from (
		SELECT IPR.*,'0' AS CU FROM IP_RESURL IPR WHERE URLBH IN (SELECT SQZYBM FROM
		IP_ARCGRANT ARC
		WHERE JLZT = #{jlzt} AND SQZYLX =#{sqzylx} AND SQDXBH = #{sqdxbh})) url
		where 1=1
		<if test="urllj != null"> and urllj like ${urllj}</if>
	</select>
	<select id="findChooseNotUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		select url.* from (
		SELECT IPR.*,'0' AS CU FROM IP_RESURL IPR WHERE URLBH not IN (SELECT SQZYBM
		FROM IP_ARCGRANT ARC
		WHERE JLZT = #{jlzt} AND SQZYLX =#{sqzylx} AND SQDXBH = #{sqdxbh})) url
		where 1=1
		<if test="urllj != null"> and urllj like ${urllj}</if>
	</select>
	<select id="findChooseUrlCount" resultType="int">
		SELECT COUNT(*) FROM IP_RESURL
	</select>
	<!-- 获取所属模块的所有URL权限 -->
	<select id="findSsmkAllUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT * FROM IP_RESURL IURL WHERE IURL.URLLJ LIKE ${gnssmk}
	</select>
	<!-- 获取角色拥有的菜单的URL权限 -->
	<select id="findRoleMenunodeUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL IURL
		WHERE IURL.URLBH IN (SELECT ARCG.SQZYBM
		FROM IP_ARCGRANT ARCG
		WHERE ARCG.SQDXBH = #{sqdxbh}
		AND ARCG.JLZT = #{jlzt}
		AND ARCG.SQZYLX = 'LJ'
		AND SQZYBM IN (SELECT URLBH FROM IP_RESURL WHERE URLLJ LIKE ${gnssmk}
		UNION ALL
		SELECT CDXBM as urlbh
		FROM IP_RESRELATION
		WHERE ZDXBM = #{cdbh}
		AND ZDXLX = 'CD'
		AND CDXLX = 'LJ'
		))
		<!-- AND IURL.URLLJ NOT IN (SELECT CDURL FROM IP_RESMENU WHERE CDBH = #{cdbh}) -->
		ORDER BY URLLJ
	</select>
	<!-- 获取角色拥有的未归属模块的所有的URL权限 <select id="findRoleMenunodeAllOtherUrl" resultMap="ipResUrl_result" 
		parameterType="java.util.HashMap"> select a.* from ip_resurl a, ip_arcgrant 
		b where a.urlbh = b.sqzybm and b.sqdxbh = #{sqdxbh} <if test="jlzt != null"> 
		AND jlzt = '1'</if> and b.sqzybm in (select urlbh from (select substr(urllj, 
		0, INSTR(urllj, '/', 2)) allmodelfromurl,urlbh,urlbm,urllj from ip_resurl) 
		where allmodelfromurl not in (select allmodelfrommenu from (select distinct 
		substr(cdurl, 0, INSTR(cdurl, '/', 2)) allmodelfrommenu from ip_resmenu where 
		cdurl is not null and cdurl <![CDATA[ <> ]]> 'other')) ) <if test="key != 
		null">and urllj like #{key} </if> order by urllj </select> -->

	<select id="findRoleMenunodeAllOtherUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		select a.*
		from ip_resurl a, ip_arcgrant b
		where a.urlbh = b.sqzybm
		and b.sqdxbh = #{sqdxbh}
		AND jlzt = '1'
		and b.sqzybm in
		<foreach item="id" index="index" collection="sqzybms" open="("
			separator="," close=")">
			#{id}
		</foreach>

		<if test="key != null">and urllj like ${key} </if>
		order by urllj
	</select>
	<!-- 获取用户拥有的合法角色【管理类和系统保留的管理类角色】的其他可分配资源 -->
	<select id="findStaffMenunodeAllOtherUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT A.*
		FROM IP_RESURL A, IP_ARCGRANT B
		WHERE A.URLBH = B.SQZYBM
		AND B.SQDXBH IN
		(SELECT JSBH
		FROM IP_ROLE
		WHERE JLZT = '1'
		AND JSBH IN
		(SELECT JSBH FROM IP_ROLE_STAFF WHERE YHBH = #{yhbh}) AND
		(JSLX ='3' OR JSLX='9')
		)
		AND JLZT = '1'
		and b.sqzybm in
		<foreach item="id" index="index" collection="sqzybms" open="("
			separator="," close=")">
			#{id}
		</foreach>
		<if test="key != null">and urllj like ${key} </if>
		ORDER BY URLLJ
	</select>

	<!-- 获取所属模块可分配的所有URL -->
	<select id="findSsmkUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL
		WHERE (URLLJ LIKE ${gnssmk}
		OR URLBH IN (SELECT CDXBM
		FROM IP_RESRELATION
		WHERE ZDXBM = #{cdbh}
		AND ZDXLX = 'CD'
		AND CDXLX = 'LJ'))
		<if test="key != null"> AND URLLJ LIKE ${key} </if>
		ORDER BY URLLJ
	</select>
	<!-- 获取登录用户拥有的合法角色所属模块可分配的所有URL -->
	<select id="findStaffSsmkUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL IURL
		WHERE IURL.URLBH IN
		(SELECT ARCG.SQZYBM
		FROM IP_ARCGRANT ARCG
		WHERE ARCG.SQDXBH in
		(SELECT JSBH
		FROM IP_ROLE
		WHERE JLZT = '1'
		AND JSBH IN
		(SELECT JSBH FROM IP_ROLE_STAFF WHERE YHBH = #{yhbh}) AND
		(JSLX ='3' OR JSLX='9')
		)
		AND ARCG.JLZT = '1'
		AND ARCG.SQZYLX = 'LJ'
		AND SQZYBM IN (SELECT URLBH
		FROM IP_RESURL
		WHERE URLLJ LIKE ${gnssmk}
		UNION ALL
		SELECT CDXBM as urlbh
		FROM IP_RESRELATION
		WHERE ZDXBM = #{cdbh}
		AND ZDXLX = 'CD'
		AND CDXLX = 'LJ'))
		<if test="key != null"> AND URLLJ LIKE ${key}</if>
		ORDER BY URLLJ
	</select>

	<!-- 分级授权查询是否有*号 -->
	<select id="hasXingHao" resultType="int" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		FROM IP_RESURL IURL
		WHERE IURL.URLLJ LIKE '%*%'
		AND IURL.URLBH IN
		(SELECT ARCG.SQZYBM
		FROM IP_ARCGRANT ARCG
		WHERE ARCG.SQDXBH in
		(SELECT JSBH
		FROM IP_ROLE
		WHERE JLZT = '1'
		AND JSBH IN
		(SELECT JSBH FROM IP_ROLE_STAFF WHERE YHBH = #{yhbh}) AND
		JSLX ='3'
		)
		AND ARCG.JLZT = '1'
		AND ARCG.SQZYLX = 'LJ'
		AND SQZYBM IN (SELECT URLBH
		FROM IP_RESURL
		WHERE URLLJ LIKE ${gnssmk}
		UNION ALL
		SELECT CDXBM as urlbh
		FROM IP_RESRELATION
		WHERE ZDXBM = #{cdbh}
		AND ZDXLX = 'CD'
		AND CDXLX = 'LJ'))
	</select>



	<!-- 分级授权带*号时获取登录用户拥有的合法角色所属模块可分配的所有URL -->
	<select id="findStaffSsmkUrlWithXingHao" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT * FROM IP_RESURL WHERE URLLJ LIKE ${gnssmk} 
		<if test="key != null"> AND URLLJ LIKE ${key}</if>
		UNION ALL 
		(
			SELECT U.* 
			FROM IP_RESURL U
			LEFT JOIN IP_RESRELATION R ON R.CDXBM = U.URLBH 
			LEFT JOIN IP_RESMENU M 	ON R.ZDXBM = M.CDBH
			WHERE CDBH=#{cdbh}
			<if test="key != null"> AND U.URLLJ LIKE ${key}</if>
		)
<!-- 		ORDER BY URLLJ -->
	</select>

	<!-- 根据功能主键获取Url信息 -->
	<select id="findUrlByGnxxzj" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT IURL.*
		FROM IP_RESURL IURL, IP_RESFUNCTION FUNC
		WHERE IURL.URLLJ = FUNC.GNDYURL
		AND FUNC.GNXXZJ =#{gnxxzj}
	</select>
	<!-- 获取未归属模块的所有的Url权限 <select id="findAllOtherUrl" resultMap="ipResUrl_result"> 
		select urlbh,urlbm,urllj from (select substr(urllj, 0, INSTR(urllj, '/', 
		2)) allmodelfromurl,urlbh,urlbm,urllj from ip_resurl) where allmodelfromurl 
		not in (select allmodelfrommenu from (select distinct substr(cdurl, 0, INSTR(cdurl, 
		'/', 2)) allmodelfrommenu from ip_resmenu where cdurl is not null and cdurl 
		<![CDATA[ <> ]]> 'other')) <if test="key != null">and urllj like #{key} </if> 
		order by urllj </select> -->
	<select id="findAllOtherUrl" resultMap="ipResUrl_result">
		select urlbh,urlbm,urllj,urlms
		from ip_resurl where urlbh in
		<foreach item="id" index="index" collection="urlList" open="("
			separator="," close=")">
			#{id}
		</foreach>
		<if test="key != null">and urllj like ${key} </if>
		order by urllj
	</select>

	<select id="findAssignedUrlByYhbh" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL
		WHERE URLBH IN (
			SELECT distinct SQZYBM
			from (
				SELECT SQZYBM
				FROM IP_ARCGRANT ARC
				WHERE JLZT = #{jlzt}
				AND SQZYLX = #{sqzylx}
				AND SQDXBH IN (SELECT R.JSBH
				FROM IP_ROLE R, IP_ROLE_STAFF RS
				WHERE R.JSBH = RS.JSBH
				AND RS.YHBH = #{yhbh}
				AND R.JSZT = '1')
				union all
				SELECT SQZYBM
				FROM IP_ARCGRANT ARC
				WHERE JLZT = #{jlzt}
				AND SQZYLX = #{sqzylx}
				AND SQDXBH = 'R99999998'
			) t_view
		)
	</select>

	<!-- 权限添加角色 -->
	<!-- 获取所属模块的URL信息，除才所属模块对应的URL外 -->
	<select id="findSsmkURlRole" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL IURL
		WHERE (IURL.URLLJ NOT IN
		(SELECT CDURL
		FROM IP_RESMENU
		WHERE CDBH = #{cdbh})

		<if test="gnssmk == null">AND IURL.URLLJ LIKE ''</if>
		<if test="gnssmk != null">AND IURL.URLLJ LIKE ${gnssmk}</if>
		OR URLBH IN
		(SELECT CDXBM
		FROM IP_RESRELATION
		WHERE ZDXBM =#{cdbh}
		AND ZDXLX = 'CD'
		AND CDXLX = 'LJ'))
		<if test="key != null"> AND IURL.URLLJ LIKE ${key}  </if>
		order by urllj asc
	</select>
	<!-- 根据菜单编号获取菜单关联URL信息 -->
	<select id="findMenuRelationUrl" resultMap="ipResUrl_result"
		parameterType="com.cib.cap4j.cfn.function.vo.IpResrelationVO">
		SELECT *
		FROM IP_RESURL
		WHERE URLBH IN (SELECT CDXBM
		FROM IP_RESRELATION
		WHERE ZDXBM = #{zdxbm}
		AND CDXLX = #{cdxlx})
		ORDER BY URLLJ
	</select>
	<!-- 获取菜单可选择关联的URL信息 -->
	<select id="findNotMenuRelationUrl" resultMap="ipResUrl_result"
		parameterType="java.util.HashMap">
		SELECT *
		FROM IP_RESURL
		WHERE URLBH NOT IN (SELECT URLBH
		FROM IP_RESURL
		WHERE URLLJ LIKE '%/**/*.*'
		<if test="gnssmk != null">
			OR URLLJ LIKE ${gnssmk}
		</if>
		)
		AND URLLJ NOT IN (SELECT CDURL FROM IP_RESMENU WHERE CDURL IS NOT NULL)
		<if test="relationurl != null">
			and URLBH NOT IN
			<foreach item="id" index="index" collection="relationurl"
				open="(" separator="," close=")">
				#{id}
			</foreach>
		</if>
		<if test="key != null and key != ''">
			AND URLLJ LIKE ${key}
		</if>
		ORDER BY URLLJ
	</select>
</mapper>
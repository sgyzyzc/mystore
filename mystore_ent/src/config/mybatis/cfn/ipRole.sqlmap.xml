<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cib.cap4j.cfn.permissionRelation.dao.PerRelationRoleDao">
	<resultMap id="ipRole_result" type="com.cib.cap4j.cfn.role.vo.IPRoleVO">
	     <id column="JSBH" property="jsbh" />
	     <result column="JSMC" property="jsmc" />
	     <result column="JSLX" property="jslx" />
	     <result column="JSZT" property="jszt" />
	     <result column="JSMS" property="jsms" />
	     <result column="CJR" property="cjr" />
	     <result column="CJSJ" property="cjsj" />
	     <result column="ZHXGR" property="zhxgr" />
	     <result column="ZHXGSJ" property="zhxgsj" />
	     <result column="JLZT" property="jlzt" />
	     <result column="JSQZ" property="jsqz" />
	     <result column="KZZD1" property="kzzd1" />
	     <result column="KZZD2" property="kzzd2" />
	     <result column="KZZD3" property="kzzd3" />
	     <result column="KZZD4" property="kzzd4" />
	     <result column="KZZD5" property="kzzd5" />
	     <result column="KZZD6" property="kzzd6" />
	</resultMap>
	<!-- 获取权限拥有的角色信息 -->	
     <select id="findPerRole" resultMap="ipRole_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
		SELECT *
		  FROM IP_ROLE
		 WHERE JSBH IN (SELECT SQDXBH
		                  FROM IP_ARCGRANT
		                 WHERE SQZYBM = #{sqzybm}
		                   AND JLZT = '1'
		                   AND SQZYLX= #{sqzylx})
		AND JLZT = '1'
    </select>
    <!-- 获取权限拥有的角色信息的总记录数 -->	
     <select id="findPerRoleCount" resultType="int" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			  SELECT COUNT(*)
		  FROM IP_ROLE
		 WHERE JSBH IN (SELECT SQDXBH
		                  FROM IP_ARCGRANT
		                 WHERE SQZYBM = #{sqzybm}
		                   AND JLZT = '1'
		                   AND SQZYLX= #{sqzylx})
		 AND JLZT = '1'
    </select>
    
    <!-- 查找未分配给用户的角色 -->
    <select id="findNotAddedRole" resultMap="ipRole_result" parameterType="java.util.Map">
    	SELECT * FROM IP_ROLE R WHERE R.JLZT='1' AND (R.JSBH NOT IN 
    	(SELECT RS.JSBH FROM IP_ROLE_STAFF RS WHERE RS.JLZT='1' AND RS.YHBH=#{yhbh}) AND R.JSBH <![CDATA[ <>]]> #{jsbh})
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    	ORDER BY R.CJSJ DESC
    </select>
    
     <!-- 统计未分配给用户的角色 -->
    <select id="countNotAddedRole" resultType="int" parameterType="java.util.Map">
    	SELECT COUNT(*) FROM IP_ROLE R WHERE R.JLZT='1' AND (R.JSBH NOT IN 
    	(SELECT RS.JSBH FROM IP_ROLE_STAFF RS WHERE RS.JLZT='1' AND RS.YHBH=#{yhbh}) AND R.JSBH <![CDATA[ <>]]> #{jsbh})
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    </select>
    
     <!-- 查找未分配给用户的角色 ,且权重<=自己-->
    <select id="findNotAddedRoleWithRankGrant" resultMap="ipRole_result" parameterType="java.util.Map">
    	SELECT * FROM IP_ROLE R WHERE R.JLZT='1' AND R.JSQZ <![CDATA[ <=]]> #{jsqz} AND (R.JSBH NOT IN 
    	(SELECT RS.JSBH FROM IP_ROLE_STAFF RS WHERE RS.JLZT='1' AND RS.YHBH=#{yhbh} UNION ALL
    	SELECT JSBH FROM IP_ROLE WHERE JSLX='3' AND JSQZ=#{jsqz}) AND R.JSBH <![CDATA[ <>]]> #{jsbh})
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    	ORDER BY R.CJSJ DESC
    </select>
    
    <!-- 统计未分配给用户的角色 ,且权重<=自己-->
    <select id="countNotAddedRoleWithRankGrant" resultType="int" parameterType="java.util.Map">
 		SELECT COUNT(*) FROM IP_ROLE R WHERE R.JLZT='1' AND R.JSQZ <![CDATA[ <=]]> #{jsqz} AND (R.JSBH NOT IN 
    	(SELECT RS.JSBH FROM IP_ROLE_STAFF RS WHERE RS.JLZT='1' AND RS.YHBH=#{yhbh} UNION ALL
    	SELECT JSBH FROM IP_ROLE WHERE JSLX='3' AND JSQZ=#{jsqz}) AND R.JSBH <![CDATA[ <>]]> #{jsbh})
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    </select>
    
    <!-- 查找分配给用户的角色 -->
    <select id="findRoleByYhbh" resultMap="ipRole_result" parameterType="java.util.Map">
    	SELECT * FROM IP_ROLE R WHERE R.JLZT='1' AND (R.JSBH IN 
    	(SELECT RS.JSBH FROM IP_ROLE_STAFF RS WHERE RS.JLZT='1' AND RS.YHBH=#{yhbh}) 
    	<if test="jsbh != null and jsbh!=''"> AND R.JSBH <![CDATA[ <>]]> #{jsbh}</if> )
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    	ORDER BY R.CJSJ DESC
    </select>
    
    <!-- 统计分配给用户的角色 -->
    <select id="countRoleByYhbh" resultType="int" parameterType="java.util.Map">
    	SELECT COUNT(*) FROM IP_ROLE R WHERE R.JLZT='1' AND (R.JSBH IN 
    	(SELECT RS.JSBH FROM IP_ROLE_STAFF RS WHERE RS.JLZT='1' AND RS.YHBH=#{yhbh}) AND R.JSBH <![CDATA[ <>]]> #{jsbh})
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    </select>
    
    <!-- 查找所有的角色 -->
    <select id="findAllRole" resultMap="ipRole_result" parameterType="java.util.Map">
    	SELECT * FROM IP_ROLE R WHERE R.JLZT='1'
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    	<if test="jslx != null and jslx!=''">  AND R.JSLX = #{jslx}</if>
    	<if test="jszt != null and jszt!=''">  AND R.JSZT = #{jszt}</if>
    	<if test="excludeCommomRole == 1 and commomRole != null"> AND R.JSBH <![CDATA[ <>]]> #{commomRole}</if>
       	<if test="kzzd1 != null and kzzd1 != ''">  AND S.KZZD1 LIKE ${kzzd1}</if>
       	<if test="kzzd2 != null and kzzd2 != ''">  AND S.KZZD2 LIKE ${kzzd2}</if>
       	<if test="kzzd3 != null and kzzd3 != ''">  AND S.KZZD3 LIKE ${kzzd3}</if>
       	<if test="kzzd4 != null and kzzd4 != ''">  AND S.KZZD4 LIKE ${kzzd4}</if>
       	<if test="kzzd5 != null and kzzd5 != ''">  AND S.KZZD5 LIKE ${kzzd5}</if>
       	<if test="kzzd6 != null and kzzd6 != ''">  AND S.KZZD6 LIKE ${kzzd6}</if>
    	ORDER BY R.CJSJ DESC
    </select>
    
    <!-- 统计所有的角色 -->
    <select id="countAllRole" resultType="int" parameterType="java.util.Map">
    	SELECT COUNT(*) FROM IP_ROLE R WHERE R.JLZT='1'
    	<if test="jsmc != null and jsmc!=''">  AND R.JSMC LIKE ${jsmc}</if>
    	<if test="jslx != null and jslx!=''">  AND R.JSLX = #{jslx}</if>
    	<if test="jszt != null and jszt!=''">  AND R.JSZT = #{jszt}</if>
    	<if test="excludeCommomRole == 1 and commomRole != null"> AND R.JSBH <![CDATA[ <>]]> #{commomRole}</if>
       	<if test="kzzd1 != null and kzzd1 != ''">  AND S.KZZD1 LIKE ${kzzd1}</if>
       	<if test="kzzd2 != null and kzzd2 != ''">  AND S.KZZD2 LIKE ${kzzd2}</if>
       	<if test="kzzd3 != null and kzzd3 != ''">  AND S.KZZD3 LIKE ${kzzd3}</if>
       	<if test="kzzd4 != null and kzzd4 != ''">  AND S.KZZD4 LIKE ${kzzd4}</if>
       	<if test="kzzd5 != null and kzzd5 != ''">  AND S.KZZD5 LIKE ${kzzd5}</if>
       	<if test="kzzd6 != null and kzzd6 != ''">  AND S.KZZD6 LIKE ${kzzd6}</if>
    </select>
    
        <!-- 查找所有权重<=自己的角色 -->
    <select id="findAllRoleWithRankGrant" resultMap="ipRole_result" parameterType="java.util.Map">
    	SELECT * FROM IP_ROLE WHERE JLZT='1' 
    	AND JSQZ <![CDATA[ <=]]> #{maxJsqz}
    	AND JSBH NOT IN
    	(
	    	SELECT JSBH FROM IP_ROLE WHERE JSLX='3'
	    	AND JSQZ = #{maxJsqz}
    	)
    	<if test="jsmc != null and jsmc!=''">  AND JSMC LIKE ${jsmc}</if>
    	<if test="jslx != null and jslx!=''">  AND JSLX = #{jslx}</if>
    	<if test="jszt != null and jszt!=''">  AND JSZT = #{jszt}</if>
    	<if test="excludeCommomRole == 1 and commomRole != null"> AND JSBH <![CDATA[ <>]]> #{commomRole}</if>
       	<if test="kzzd1 != null and kzzd1 != ''">  AND S.KZZD1 LIKE ${kzzd1}</if>
       	<if test="kzzd2 != null and kzzd2 != ''">  AND S.KZZD2 LIKE ${kzzd2}</if>
       	<if test="kzzd3 != null and kzzd3 != ''">  AND S.KZZD3 LIKE ${kzzd3}</if>
       	<if test="kzzd4 != null and kzzd4 != ''">  AND S.KZZD4 LIKE ${kzzd4}</if>
       	<if test="kzzd5 != null and kzzd5 != ''">  AND S.KZZD5 LIKE ${kzzd5}</if>
       	<if test="kzzd6 != null and kzzd6 != ''">  AND S.KZZD6 LIKE ${kzzd6}</if>
    	ORDER BY CJSJ DESC
    </select>
    
       <!-- 统计所有权重<=自己的角色 -->
    <select id="countAllRoleWithRankGrant" resultType="int" parameterType="java.util.Map">
    	SELECT COUNT(*) FROM IP_ROLE WHERE JLZT='1' 
    	AND JSQZ <![CDATA[ <=]]> #{maxJsqz}
    	AND JSBH NOT IN
    	(
	    	SELECT JSBH FROM IP_ROLE WHERE JSLX='3'
	    	AND JSQZ = #{maxJsqz}
    	)
    	<if test="jsmc != null and jsmc!=''">  AND JSMC LIKE ${jsmc}</if>
    	<if test="jslx != null and jslx!=''">  AND JSLX = #{jslx}</if>
    	<if test="jszt != null and jszt!=''">  AND JSZT = #{jszt}</if>
    	<if test="excludeCommomRole == 1 and commomRole != null"> AND JSBH <![CDATA[ <>]]> #{commomRole}</if>
       	<if test="kzzd1 != null and kzzd1 != ''">  AND S.KZZD1 LIKE ${kzzd1}</if>
       	<if test="kzzd2 != null and kzzd2 != ''">  AND S.KZZD2 LIKE ${kzzd2}</if>
       	<if test="kzzd3 != null and kzzd3 != ''">  AND S.KZZD3 LIKE ${kzzd3}</if>
       	<if test="kzzd4 != null and kzzd4 != ''">  AND S.KZZD4 LIKE ${kzzd4}</if>
       	<if test="kzzd5 != null and kzzd5 != ''">  AND S.KZZD5 LIKE ${kzzd5}</if>
       	<if test="kzzd6 != null and kzzd6 != ''">  AND S.KZZD6 LIKE ${kzzd6}</if>
    </select>
    
      <!-- 用户拥有的权限最高的管理角色 权重-->
    <select id="getMaxRoleWeightsByYhbh" resultType="int" parameterType="java.lang.String">
    	SELECT CASE WHEN MAX(R.JSQZ)  IS NOT NULL THEN  MAX(R.JSQZ) ELSE 0 END 
    	FROM IP_ROLE_STAFF RS 
    	LEFT JOIN IP_ROLE R 
    	ON RS.JSBH = R.JSBH 
    	WHERE RS.JLZT='1' 
    	AND R.JLZT='1' 
    	AND RS.YHBH=#{_parameter}
    	AND JSLX='3'
    </select>     
</mapper>		
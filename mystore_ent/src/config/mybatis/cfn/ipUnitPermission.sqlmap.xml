<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cib.cap4j.cfn.permissionRelation.dao.IRoleAssignPermissionDao">
		<resultMap id="ipUnitPermission_result" type="com.cib.cap4j.cfn.unitPermissionManage.vo.IpUnitPermissionVO">
		     <id column="ZZJGQXZJ" property="zzjgqxzj" />
		     <id column="ZZQXBM" property="zzqxbm" />
		     <result column="ZZQXMC" property="zzqxmc" />
		     <result column="SSMK" property="ssmk" />
		     <result column="QXFX" property="qxfx" />
		     <result column="ZZJGBC" property="zzjgbc" />
		     <result column="TJ" property="tj" />
		     <result column="SFBHZJ" property="sfbhzj" />
		</resultMap>
		
		<resultMap id="ipUnitVO" type="com.cib.cap4j.cfn.unit.vo.IPUnitVO">
		     
		</resultMap>
		
     <select id="findRoleUnitPer" resultMap="ipUnitPermission_result" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			  SELECT * FROM ip_unit_permission WHERE ZZJGQXZJ IN (SELECT SQZYBM FROM  IP_ARCGRANT ARC
            WHERE JLZT = #{jlzt}  AND SQZYLX = #{sqzylx} AND SQDXBH = #{sqdxbh})
    </select>
     <select id="findRoleUnitPerCount" resultType="int" parameterType="com.cib.cap4j.cfn.grant.vo.IPArcGrantVO">
			  SELECT COUNT(*) FROM IP_UNIT_PERMISSION WHERE ZZJGQXZJ IN (SELECT SQZYBM FROM  IP_ARCGRANT ARC
            WHERE JLZT = #{jlzt}  AND SQZYLX =#{sqzylx} AND SQDXBH =#{sqdxbh})
    </select>
	<!-- 获取用户拥有的管理类角色的组织机构数据权限 -->
     <select id="findStaffRoleUnitPerList" resultMap="ipUnitPermission_result" parameterType="java.util.HashMap">
		SELECT *
		  FROM IP_UNIT_PERMISSION
		 WHERE ZZJGQXZJ IN
		       (SELECT SQZYBM
		          FROM IP_ARCGRANT ARC
		         WHERE JLZT = #{jlzt}
		           AND SQZYLX = #{sqzylx}
		           AND SQDXBH IN (SELECT JSBH
		                            FROM IP_ROLE
		                           WHERE JLZT = #{jlzt}
		                             AND JSBH IN (SELECT JSBH
		                                            FROM IP_ROLE_STAFF
		                                           WHERE YHBH = #{yhbh})
		                             AND (JSLX = '3' OR JSLX = '9')))
    </select>
    <!-- 获取用户拥有的管理类角色的组织机构数据权限Count -->
    <select id="findStaffRoleUnitPerListCount" resultType="int" parameterType="java.util.HashMap">
		SELECT COUNT(*)
		  FROM IP_UNIT_PERMISSION
		 WHERE ZZJGQXZJ IN
		       (SELECT SQZYBM
		          FROM IP_ARCGRANT ARC
		         WHERE JLZT = #{jlzt}
		           AND SQZYLX = #{sqzylx}
		           AND SQDXBH IN (SELECT JSBH
		                            FROM IP_ROLE
		                           WHERE JLZT = #{jlzt}
		                             AND JSBH IN (SELECT JSBH
		                                            FROM IP_ROLE_STAFF
		                                           WHERE YHBH = #{yhbh})
		                             AND (JSLX = '3' OR JSLX = '9')))
    </select>
    
    <!-- 获取用户拥有的机构权限 -->
	<select id="findAssignedUnitByYhbh" resultMap="ipUnitPermission_result" parameterType="java.util.HashMap">
			SELECT * FROM IP_UNIT_PERMISSION WHERE ZZJGQXZJ IN 
			( SELECT SQZYBM FROM  IP_ARCGRANT ARC WHERE JLZT = #{jlzt} AND SQZYLX = #{sqzylx} AND SQDXBH IN
				(SELECT R.JSBH FROM IP_ROLE R, IP_ROLE_STAFF RS WHERE (R.JSBH = RS.JSBH AND RS.YHBH = #{yhbh} AND R.JSZT='1') OR R.JSBH='R99999998'))
			 
	</select>
	
	<!-- 根据登录用户的角色查找机构列表 -->
	<!-- 根据角色查机构权限 -->
	<select id="findDirectionByRole" resultMap="ipUnitPermission_result" parameterType="java.lang.String">
		select u.* from ip_arcgrant t,ip_unit_permission u 
			where t.sqzybm=u.zzjgqxzj and t.sqdxbh=#{role} and t.jlzt = '1'
	</select>
	
	<select id="findSSMKByRole" resultMap="ipUnitPermission_result" parameterType="java.lang.String">
		select u.ssmk from ip_arcgrant t,ip_unit_permission u 
			where t.sqzybm=u.zzjgqxzj and t.sqdxbh=#{role} and t.jlzt = '1'
	</select>
	
	<!-- 自己节点 -->
	<select id="findUnitOnly" parameterType="java.util.Map"  resultMap="ipUnitVO">
		select u.* from ip_unitcode_permission t,ip_unit u 
			where t.jgh = u.jgbh and t.sjbsjqxbh= #{zj} and u.jlzt = '1'
	</select>
	
	<select id="findTreePath" parameterType="java.util.Map"  resultType="java.lang.String">
		select u.xzcxlj from ip_unitcode_permission t,ip_unit u 
			where t.jgh = u.jgbh and t.sjbsjqxbh= #{zj} and u.jlzt = '1'  
	</select>
	
	<!-- 查询所有上级节点 -->
	<select id="findUnitUp" parameterType="java.util.Map"  resultMap="ipUnitVO">
         select distinct u.* from ip_unit u where u.zj in 
         <foreach collection="idList" item="oneId" open="(" close=")" separator=",">
			'${oneId}'
		 </foreach>  
         and u.jlzt = '1' 
	</select>
	
	<!-- 查询下级所有节点 -->
	<select id="findUnitDownComm" parameterType="java.util.Map"  resultMap="ipUnitVO">
		select * from ip_unit u where u.xzcxlj like #{path} 
		<![CDATA[and u.xzcxlj <> #{removePath}]]>  
		and u.jlzt = '1'
	</select>
	
	<!-- 兄弟节点 -->
	<select id="findUnitBrother" parameterType="java.util.Map" resultMap="ipUnitVO">
		select distinct u.* from ip_unit u where u.zj not in
		<foreach collection="unitIdList" item="oneId" open="(" close=")" separator=",">
			'${oneId}'
		</foreach> 
		and u.xzsjgljgbh in 
		<foreach collection="superUnitIdList" item="oneId" open="(" close=")" separator=",">
			'${oneId}'
		</foreach> 
		and u.jlzt = '1'
	</select>
	
	<select id="findDownUnit" parameterType="java.util.Map" resultType="java.lang.String">
		select u.zj from ip_unit u where u.xzsjgljgbh = #{unitId} and u.jlzt = '1'
	</select>
			
</mapper>    